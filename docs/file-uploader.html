<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Serial File Uploader</title>
<style>
body { font-family: Arial; padding:20px; }
progress { width: 100%; height: 20px; }
</style>
</head>
<body>

<h2>Serial File Uploader</h2>

<button id="connect">Connect Device</button>
<br><br>

<input type="file" id="files" webkitdirectory multiple>
<br><br>

<button id="upload">Upload</button>

<p id="status"></p>
<progress id="progress" value="0" max="100"></progress>

<script>
let port, reader, writer;

const CHUNK = 1024;

function crc32(buf) {
    let table = new Uint32Array(256).map((_, i) => {
        let c = i;
        for (let k = 0; k < 8; k++)
            c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
        return c >>> 0;
    });
    let crc = 0 ^ (-1);
    for (let i = 0; i < buf.length; i++)
        crc = (crc >>> 8) ^ table[(crc ^ buf[i]) & 0xFF];
    return (crc ^ (-1)) >>> 0;
}

async function readLine() {
    let line = "";
    while (true) {
        const { value } = await reader.read();
        if (!value) continue;
        for (let b of value) {
            if (b === 10) return line.trim();
            line += String.fromCharCode(b);
        }
    }
}

async function sendLine(s) {
    await writer.write(new TextEncoder().encode(s + "\n"));
}

async function sendChunk(index, data) {
    const checksum = crc32(data);

    await sendLine("CHUNK");
    await sendLine(index);
    await sendLine(data.length);
    await sendLine(checksum);

    await writer.write(data);

    while (true) {
        const resp = await readLine();
        if (resp === "OK " + index) return true;
        if (resp === "RESEND " + index) break;
    }
    return false;
}

document.getElementById("connect").onclick = async () => {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 921600 });

    writer = port.writable.getWriter();
    reader = port.readable.getReader();

    await sendLine("HELLO");
    const r = await readLine();
    document.getElementById("status").innerText = r;
};

document.getElementById("upload").onclick = async () => {
    const files = document.getElementById("files").files;

    for (const file of files) {

        const data = new Uint8Array(await file.arrayBuffer());
        const totalChunks = Math.ceil(data.length / CHUNK);

        document.getElementById("status").innerText = "Sending " + file.webkitRelativePath;

        await sendLine("FILE");
        await sendLine(file.webkitRelativePath);
        await sendLine(data.length);
        await sendLine(CHUNK);
        await sendLine(crc32(data));

        await readLine(); // OK

        for (let i = 0; i < totalChunks; i++) {
            const start = i * CHUNK;
            const end = Math.min(start + CHUNK, data.length);
            const chunk = data.slice(start, end);

            while (!(await sendChunk(i, chunk))) {}

            const progress = Math.floor((i + 1) / totalChunks * 100);
            document.getElementById("progress").value = progress;
        }

        await sendLine("DONE");
        console.log(await readLine());
    }

    await sendLine("END");
    document.getElementById("status").innerText = "Upload complete";
};
</script>
</body>
</html>
